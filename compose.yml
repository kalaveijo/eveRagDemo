services:
  # PostgreSQL with pgvector extension
  pgvector:
    image: pgvector/pgvector:pg18-trixie
    container_name: eve_pgvector
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    ports:
      - "5432:5432"
    volumes:
      - pgvector_data:/var/lib/postgresql
    networks:
      - eve_network

  # Ollama LLM service
  ollama:
    image: ollama/ollama:latest
    container_name: eve_ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0:11434
    networks:
      - eve_network
    post_start:
      - command: ollama pull qwen3:1.7b
        user: root
      - command: ollama pull embeddinggemma:300m
        user: root

  # Eve Online RAG Bot
  evewikibot:
    build:
      #context: ..
      dockerfile: Dockerfile
    container_name: eve_wikibot
    environment:
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL}
      - OLLAMA_MODEL=${OLLAMA_MODEL}
      - OLLAMA_EMBEDDING_MODEL=${OLLAMA_EMBEDDING_MODEL}
      - OLLAMA_TEMPERATURE=${OLLAMA_TEMPERATURE}
      - PGVECTOR_HOST=${PGVECTOR_HOST}
      - PGVECTOR_PORT=${PGVECTOR_PORT}
      - PGVECTOR_DATABASE=${PGVECTOR_DATABASE}
      - PGVECTOR_USER=${PGVECTOR_USER}
      - PGVECTOR_PASSWORD=${PGVECTOR_PASSWORD}
      - PGVECTOR_COLLECTION=${PGVECTOR_COLLECTION}
      - PGVECTOR_EMBEDDING_DIM=${PGVECTOR_EMBEDDING_DIM}
      - PGVECTOR_TOP_K=${PGVECTOR_TOP_K}
      - DEBUG=${DEBUG}
    depends_on:
      pgvector:
        condition: service_started
      ollama:
        condition: service_started
    networks:
      - eve_network

  # Eve Wiki Bot Frontend
  evewikibotfront:
    build:
      dockerfile: Dockerfile.frontend
    container_name: eve_wikibot_frontend
    ports:
      - "8501:8501"
    environment:
      - BACKEND_URL=http://evewikibot:8000
    depends_on:
      - evewikibot
    networks:
      - eve_network

volumes:
  pgvector_data:
    driver: local
  ollama_data:
    driver: local

networks:
  eve_network:
    driver: bridge
